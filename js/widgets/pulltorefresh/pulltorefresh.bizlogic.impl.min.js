!function(t){"use strict";function e(t){if(null==t||"string"!=typeof t)return null;var e,i=document.createElement("div"),s=document.createDocumentFragment();for(i.innerHTML=t;e=i.firstChild;)s.appendChild(e);return s}function i(e){var i=this;e=t.extend(!0,{},a,e);var s=e.template;if("string"==typeof s&&/^[.#]/.test(s)||s instanceof HTMLElement){var n=t.selector(s);n&&(s=n.innerHTML.toString()||"")}e.template=s;var o=e.skin||PullToRefreshTools.skin.defaults;if(!o)throw new Error("错误:传入的下拉刷新皮肤错误,超出范围!");var r=e.setting;r.container=e.container,r.down&&(r.down.callback=function(){i._pullDownCallback()}),r.up&&(r.up.callback=function(){i._pullUpCallback()}),this.container=t.selector(e.container),this.listContainer=t.selector(e.listContainer),this.options=e,this.setting=r,this._initParams(),this.instance=new o(r),this._addEvent()}var s=Util.dataProcess,n="ontouchstart"in document,o=n?"tap":"click",a={isDebug:!1,container:"#pullrefresh",listContainer:"#listdata",type:"POST",initPageIndex:0,pageSize:10,url:null,template:"#item-template",dataRequest:null,dataChange:null,itemClick:null,success:null,error:null,refresh:null,isAutoRender:!0,itemSelector:"li",delay:0,timeout:6e3,accepts:{script:"text/javascript, application/javascript, application/x-javascript",json:"application/json",xml:"application/xml, text/xml",html:"text/html",text:"text/plain"},contentType:"application/x-www-form-urlencoded",headers:null,setting:{down:{isSuccessTips:!0},up:{auto:!0}}};i.prototype={_initParams:function(){this.isShouldNoMoreData=!0,this.currPage=this.options.initPageIndex,this.setting.up&&this.setting.up.auto&&this.currPage--},_pullDownCallback:function(){var t=this,e=this.options;this.loadingDown||(this.isPullDown=!0,this.loadingDown=!0,this.currPage=e.initPageIndex,setTimeout(function(){t._ajaxRequest()},e.delay),e.refresh&&e.refresh(!0))},_pullUpCallback:function(){var t=this;this.loadingUp||(this.isPullDown=!1,this.loadingUp=!0,this.currPage++,setTimeout(function(){t._ajaxRequest()},this.options.delay))},_clearResponseEl:function(){this.options.isAutoRender&&this.listContainer&&(this.listContainer.innerHTML="")},_render:function(t){var i=this.options,s=0;if(i.isAutoRender)if(this.isPullDown&&this._clearResponseEl(),window.Mustache)if(t&&Array.isArray(t)&&t.length>0){for(var n="",o=0,a=t.length;o<a;o++){var r=t[o],l="";i.template&&("string"==typeof i.template?l=i.template:"function"==typeof i.template&&(l=i.template(r))),n+=Mustache.render(l,r),s++}""!=n&&this.listContainer.appendChild(e(n))}else this.isShouldNoMoreData=!1;else this.isShouldNoMoreData=!1,i.isDebug&&console.error("error***没有包含mustache文件,无法进行模板渲染");return s},_dataChangeDefault:function(t){var e=s(t,{dataPath:["custom.infolist","custom.infoList","UserArea.InfoList"]});return e.data},_ajaxRequest:function(){var t=this,e=this.options;if(!e.url)return e.isDebug&&console.error("error***url无效,无法访问"),void this._errorRequest(null,null,"请求url为空!");var i=function(i){var s="";s="function"==typeof e.url?e.url():e.url,Util.ajax({url:s,data:i,dataType:"json",timeout:e.timeout,type:e.type,accepts:e.accepts,headers:e.headers,contentType:e.contentType,success:function(e){t._successRequest(e)},error:function(e,i){t._errorRequest(e,i,"请求失败!")}})};if(e.dataRequest){var s=e.dataRequest(this.currPage,function(t){i(t)});void 0!==s&&i(s)}else e.isDebug&&console.warn("warning***请注意dataRequest不存在,默认数据为空"),i()},_errorRequest:function(t,e,i){var s=this.options;this.isShouldNoMoreData=!1,this._refreshState(!1),this.currPage--,this.currPage=this.currPage>=s.initPageIndex?this.currPage:s.initPageIndex,s.error&&s.error(t,e,i)},_successRequest:function(t){var e=this.options;if(!t)return e.isDebug&&console.log("warning***返回的数据为空,请注意！"),this.isShouldNoMoreData=!1,void this._refreshState(!1);e.isDebug&&console.log("下拉刷新返回数据:"+JSON.stringify(t)),t=e.dataChange?e.dataChange(t):this._dataChangeDefault(t);var i=this._render(t);this.loadingMoreSuccess&&(this.loadingMoreSuccess(),this.loadingMoreSuccess=null),e.success&&"function"==typeof e.success&&e.success(t,this.isPullDown||this.currPage==e.initPageIndex),this._refreshState(!0,i)},_refreshState:function(t,e){var i=this.instance;e=e||0,i.setSuccessTips&&i.setSuccessTips("更新"+e+"条数据"),this.isPullDown&&(i.endPullDownToRefresh(t),i.finished&&(i.refresh(!0),this.isShouldNoMoreData=!0)),this.isShouldNoMoreData?i.endPullUpToRefresh(!1,t):i.endPullUpToRefresh(!0,t),this.loadingDown=!1,this.loadingUp=!1},_addEvent:function(){var t=this.listContainer,e=this.options,i=e.itemClick;"function"==typeof i&&mui(t).on(o,e.itemSelector,i)},refresh:function(){var t=this.options;t.up&&this.instance.enablePullUp?this.loadingUp||(this._clearResponseEl(),this.currPage=t.initPageIndex-1,this.loadingMore()):(this._clearResponseEl(),this._pullDownCallback())},loadingMore:function(t){var e=this.instance;this.loadingMoreSuccess=t,this.instance.finished&&(this.instance.refresh(!0),this.isShouldNoMoreData=!0),e.pullupLoading()},disablePullupToRefresh:function(){this.pullToRefreshInstance.disablePullupToRefresh()},enablePullupToRefresh:function(){this.pullToRefreshInstance.enablePullupToRefresh()},destroy:function(){mui(listContainer).off(),this.container=null,this.listContainer=null,this.instance=null,this.options=null}},t.namespace("bizlogic",i)}(PullToRefreshTools);